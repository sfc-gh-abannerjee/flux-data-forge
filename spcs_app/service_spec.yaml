# =============================================================================
# Flux Data Forge - SPCS Service Specification
# =============================================================================
# This spec is used by:
#   1. snowflake.yml (via snow spcs service deploy)
#   2. Manual CREATE SERVICE commands
#
# For snowflake.yml deployment, set environment variables:
#   export FLUX_DATABASE=MY_DATABASE
#   export FLUX_SCHEMA=MY_SCHEMA
#   export FLUX_WAREHOUSE=MY_WAREHOUSE
#   export FLUX_ROLE=MY_ROLE
#   export FLUX_IMAGE_REPO=MY_REPO
#   snow spcs service deploy flux_data_forge
#
# For manual deployment, replace <% ... %> placeholders with actual values.
# =============================================================================

spec:
  containers:
    - name: flux-data-forge
      image: /<% ctx.env.FLUX_DATABASE | default('FLUX_DATA_FORGE') %>/<% ctx.env.FLUX_SCHEMA | default('PUBLIC') %>/<% ctx.env.FLUX_IMAGE_REPO | default('FLUX_DATA_FORGE_REPO') %>/flux_data_forge:latest
      env:
        # Snowflake Configuration
        SNOWFLAKE_DATABASE: <% ctx.env.FLUX_DATABASE | default('FLUX_DATA_FORGE') %>
        SNOWFLAKE_SCHEMA: <% ctx.env.FLUX_SCHEMA | default('PUBLIC') %>
        SNOWFLAKE_ROLE: <% ctx.env.FLUX_ROLE | default('SYSADMIN') %>
        SNOWFLAKE_WAREHOUSE: <% ctx.env.WAREHOUSE | default('FLUX_WH') %>
        
        # AMI Streaming Configuration
        AMI_TABLE: AMI_STREAMING_READINGS
        SERVICE_AREA: HOUSTON_METRO
        LOG_LEVEL: INFO
        
        # PostgreSQL Configuration (optional - for Managed Postgres dual-write)
        # POSTGRES_HOST: <your-postgres-host>.snowflake.app
        # POSTGRES_DATABASE: postgres
        # POSTGRES_USER: application
        # POSTGRES_PORT: "5432"
        
        # AWS Configuration (optional - for S3 External Stage streaming)
        # AWS_REGION: us-west-2
        # AWS_ROLE_ARN: arn:aws:iam::<YOUR_AWS_ACCOUNT>:role/<YOUR_ROLE_NAME>
      
      # Secrets (configure in Snowflake before deployment)
      # secrets:
      #   - snowflakeSecret: <DATABASE>.<SCHEMA>.STREAMING_KEY
      #     directoryPath: '/usr/local/creds'
      #   - snowflakeSecret: <DATABASE>.<SCHEMA>.POSTGRES_CREDENTIALS
      #     secretKeyRef: password
      #     envVarName: POSTGRES_PASSWORD
      
      resources:
        requests:
          cpu: 1
          memory: 2Gi
        limits:
          cpu: 2
          memory: 4Gi
          
  endpoints:
    - name: app
      port: 8080
      public: true
